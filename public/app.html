<!DOCTYPE html>
<html>
  <head>
    <title>Bitter Cassava</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="icon"
      href="https://cdn3.iconfinder.com/data/icons/vegetables-outline-2/64/yum_cassava_vegetable_organic_vegetarian-512.png"
    />
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" />
    <link href="https://fonts.googleapis.com/css?family=Monoton" rel="stylesheet" media />
    <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet" media />
    <link href="https://fonts.googleapis.com/css?family=Josefin+Sans" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Quicksand" rel="stylesheet" />
    <link
      href="https://fonts.googleapis.com/css2?family=Overpass+Mono:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />
    <link href="https://fonts.googleapis.com/css?family=Cousine" rel="stylesheet" />
    <link
      href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,200;0,300;0,400;1,200;1,300;1,400&display=swap"
      rel="stylesheet"
    />

    <link
      rel="stylesheet"
      media="screen"
      href="https://fontlibrary.org/face/office-code-pro"
      type="text/css"
    />
    <link href="/stylesheets/footer.css" rel="stylesheet" type="text/css" />
    <link href="/stylesheets/header.css" rel="stylesheet" type="text/css" />
    <link href="/stylesheets/video.css" rel="stylesheet" type="text/css" />
    <link href="/stylesheets/poetry.css" rel="stylesheet" type="text/css" />
  </head>
  <body>
    <div class="contentContainer">
      <div class="modal-overlay closed" id="modal-overlay"></div>
      <div class="modal closed" id="modal">
        <div class="headtop">
          <a class="close-button" href="#" id="close-button">
            <img
              class="playButton"
              src="https://cdn.pixabay.com/photo/2014/09/26/10/45/delete-462216_1280.png"
              alt=""
              width="20"
              height="20"
            />
          </a>
          <h1>RECENTLY PLAYED</h1>
        </div>
        <div class="modal-guts">
          <div>
            <ol class="recentlyPlayed"></ol>
          </div>
        </div>
      </div>
      <div class="poetry closed" id="poetry">
        <a class="poetry-close-button" href="#" id="poetryCloseButton">
          <img
            class="playButton"
            src="https://cdn.pixabay.com/photo/2014/09/26/10/45/delete-462216_1280.png"
            alt=""
            width="20"
            height="20"
          />
        </a>
        <div class="poetry-guts">
          <div>
            <div id="title" class="title"></div>
            <div id="author" class="author"></div>
            <div id="poem" class="poem_text"></div>

          </div>
        </div>

      </div>
      <div class="video-background">
        <div class="video-foreground">
          <!--<iframe id="backgroundvid" <iframe width="560" height="315" src="/videos/SP.mp4?autoplay=1" frameborder="0"  mute="1" allow="accelerometer; autoplay *; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>></iframe>-->
          <div class="row">
            <div class="column">
              <video autoplay="autoplay" loop="loop">
                <source src="/gifs/durimel.mp4" type="video/mp4" />
              </video>
              <img src="/gifs/popcaan.gif" />
              <img src="/gifs/dancaesar.gif" />
              <img src="/gifs/fp.gif" />
            </div>
            <div class="column">
              <img src="/gifs/dap.gif" />
              <img src="/gifs/shellyann.gif" />
              <img src="/gifs/gs.gif" />
              <img src="/gifs/atu.gif" />
              <img src="/gifs/denzel.gif" />
              <img src="/gifs/giphy.gif" />
            </div>
            <div class="column">
              <img src="/gifs/caine.gif" />
              <img src="/gifs/drake.gif" />
              <img src="/gifs/dance.gif" />
              <img src="/gifs/ethiopia.gif" />
            </div>
            <div class="column">
              <img src="/gifs/serena.gif" />
              <img src="/gifs/jorja.gif" />
              <img src="/gifs/praise.gif" />
              <img src="/gifs/dance.gif" />
              <img src="/gifs/denzel.gif" />
              <img src="/gifs/giphy.gif" />
            </div>
            <div class="column">
              <img src="/gifs/atu.gif" />
              <img src="/gifs/car.gif" />
              <img src="/gifs/ghana.gif" />
              <img src="/gifs/icecube.gif" />
              <img src="/gifs/sofiegif.gif" />
              <img src="/gifs/giphy.gif" />
            </div>
            <div class="column">
              <img src="/gifs/testimage.gif" />
              <img src="/gifs/giphy.gif" />
              <img src="/gifs/sofiegif.gif" />
            </div>
          </div>
        </div>
      </div>
      <header class="header-container">
        <div class="Live">
          <div class="label-wrapper">
            <span>Live Now</span>
            <span class="circle"></span>
          </div>
        </div>
        <div class="StreamBar">
          <input
            type="image"
            id="channel1"
            class="playButton paused"
            src="http://simpleicon.com/wp-content/uploads/play1-64x64.png"
            alt=""
            width="32"
            height="32"
          />
          <span>Channel 1: Molasses w/ Toby</span>
          <span class="location">Dublin</span>
        </div>
        <div class="NowPlaying">
          <input
            type="image"
            id="channel2"
            class="playButton paused"
            src="http://simpleicon.com/wp-content/uploads/play1-64x64.png"
            alt=""
            width="32"
            height="32"
          />
          <span>Channel 2: </span>
          <span class="">Totems </span>
          <span>w/ </span>
          <span class="">Tweet </span>
          <span class="location">Lagos</span>
          <!--<img src="https://www.slantmagazine.com/wp-content/uploads/2005/03/itsmeagain.jpg" alt="" width="32" height="32">-->
        </div>
        <div class="icons">
          <div class="imgIcon">
            <a href="#" id="openHistory"
              ><img
                src="https://cdn0.iconfinder.com/data/icons/google-material-design-3-0/48/ic_playlist_play_48px-512.png"
                width="28"
                height="28"
            /></a>
          </div>
          <div class="imgIcon">
            <a href="#" id="openPoetry"
              ><img
                src="https://static.thenounproject.com/png/1053373-200.png"
                width="28"
                height="28"
            /></a>
          </div>
          <div class="imgIcon">
            <img
              src="https://cdn0.iconfinder.com/data/icons/google-material-design-3-0/48/ic_playlist_play_48px-512.png"
              width="28"
              height="28"
            />
          </div>
        </div>
      </header>
      <!-- <div class="cloudContent">
    </div>-->
      <footer>
        <div id="player-container">
          <div id="play-button-container">
            <svg x="0px" y="0px" width="300px" height="300px" viewBox="0 0 300 300" fill="#fff">
              <defs>
                <path
                  id="circlePath"
                  d=" M 150, 150 m -60, 0 a 60,60 0 0,1 120,0 a 60,60 0 0,1 -120,0 "
                ></path>
              </defs>
              <circle cx="100" cy="100" r="50" fill="none" stroke="none"></circle>
              <g>
                <use xlink:href="#circlePath" fill="none"></use>
                <text fill="red" stroke="#fff">
                  <textPath xlink:href="#circlePath" fill="#fff">• BITTER • CASSAVA</textPath>
                </text>
              </g>
            </svg>
          </div>
        </div>
      </footer>
    </div>
  </body>
  <script src="https://code.jquery.com/jquery-1.10.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/js-cookie@rc/dist/js.cookie.min.js"></script>

  <script type="text/javascript">
    var modal = document.querySelector('#modal');
    var modalOverlay = document.querySelector('#modal-overlay');
    var closeButton = document.querySelector('#close-button');
    var openButton = document.querySelector('#openHistory');

    var poetry = document.querySelector('#poetry');
    var poetryCloseButton = document.querySelector('#poetryCloseButton');
    var poetryOpenButton = document.querySelector('#openPoetry');



    closeButton.addEventListener('click', function () {
      modal.classList.toggle('closed');
      modalOverlay.classList.toggle('closed');
    });

    poetryCloseButton.addEventListener('click', function () {
      poetry.classList.toggle('closed');
      modalOverlay.classList.toggle('closed');
    });

    openButton.addEventListener('click', function () {
      modal.classList.toggle('closed');
      modalOverlay.classList.toggle('closed');
      openButton.classList.toggle('bright');
    });

    poetryOpenButton.addEventListener('click', function () {
      poetry.classList.toggle('closed');
      modalOverlay.classList.toggle('closed');
      poetryOpenButton.classList.toggle('bright');
    });
  </script>
  <script type="text/javascript">
    var socket = io();
    var uri;
    var userdeviceID;

    // get hash parameters from the url
    function getHashParams() {
      var hashParams = {};
      var e,
        r = /([^&;=]+)=?([^&;]*)/g,
        q = window.location.hash.substring(1);
      while ((e = r.exec(q))) {
        hashParams[e[1]] = decodeURIComponent(e[2]);
      }
      return hashParams;
    }

    //var params = getHashParams();
    //var access_token = params.access_token;
    //var refresh_token = params.refresh_token;
    //var error = params.error;

    var refresh_token = Cookies.get('refresh_token');
    var access_token = Cookies.get('access_token');

    var devicesObj;

    function refreshToken() {
      $.ajax({
        url: '/refresh_token',
        data: {
          refresh_token: refresh_token,
        },
      })
        .done(function (data) {
          access_token = data.access_token;
          Cookies.set('access_token', access_token);
          console.log('Token Refresh');

          console.log(access_token);
        })
        .fail(function (xhr, status, error) {
          //Ajax request failed.
          var errorMessage = xhr.status + ': ' + xhr.statusText;
          alert('Error - ' + errorMessage);
        });
    }

    setTimeout(refreshToken, 1000000);
    getUserDeviceInfo();

    //client socket stuff - joining channels, triggers for spotify api requests etc.

    function transferPlayback() {
      $.ajax({
        url: 'https://api.spotify.com/v1/me/player',
        headers: {
          Authorization: 'Bearer ' + access_token,
        },
        contentType: 'application/json',
        type: 'PUT',
        data: JSON.stringify({ device_ids: [userdeviceID] }),
      }).done(function (response) {
        console.log('Playback successfully transferred');
      });
    }

    function joinChannel(channelNum) {
      socket.emit('join', channelNum);
    }

    function leaveChannel(channelNum) {
      socket.emit('leave', channelNum);
    }

    socket.on('tapIn', function (data) {
      //transferPlayback();

      $.ajax({
        url: 'https://api.spotify.com/v1/me/player/play',
        contentType: 'application/json',
        type: 'PUT',
        dataType: 'json',
        headers: {
          Authorization: 'Bearer ' + access_token,
        },
        data: JSON.stringify({
          uris: [data.uri],
          device_id: userdeviceID,
          position_ms: data.progress,
        }),
        success: function (response) {
          $('.recentlyPlayed').prepend(
            $('<li>', { class: 'header-list-item' }).append(
              $('<div/>', { class: 'histContainer' }).append(
                $('<div/>').append(
                  $('<img/>', { src: data.imgsrc, alt: '', width: 48, height: 48 }),
                ),
                $('<div/>', { class: 'metadata', id: data.trackID }).append(
                  $('<span/>', { class: 'artistName', text: data.artistName }),
                  $('<span/>', { class: 'songName', text: data.songName }),
                  $('<span/>', { class: 'albumName', text: data.albumName }),
                ),
                $('<div/>', { class: 'header-add-song-icon' }).append(
                  $('<img/>', {
                    class: 'addSong',
                    id: data.trackID,
                    src:
                      'https://images.vexels.com/media/users/3/139162/isolated/preview/8b23fcb6b6c68d0f290b8dc5b5252214-cross-or-plus-icon-by-vexels.png',
                    alt: '',
                    width: 18,
                    height: 18,
                  }),
                ),
              ),
            ),
            $('<hr>'),
          );
        },
      });
    });
    socket.on('playSong', function (data) {
      //transferPlayback();

      $.ajax({
        url: 'https://api.spotify.com/v1/me/player/play',
        contentType: 'application/json',
        type: 'PUT',
        dataType: 'json',
        headers: {
          Authorization: 'Bearer ' + access_token,
        },
        data: JSON.stringify({ uris: [data.uri], device_id: userdeviceID }),
        success: function (response) {
          $('.recentlyPlayed').prepend(
            $('<li>', { class: 'header-list-item' }).append(
              $('<div/>', { class: 'histContainer' }).append(
                $('<div/>').append(
                  $('<img/>', { src: data.imgsrc, alt: '', width: 48, height: 48 }),
                ),
                $('<div/>', { class: 'metadata', id: data.trackID }).append(
                  $('<span/>', { class: 'artistName', text: data.artistName }),
                  $('<span/>', { class: 'songName', text: data.songName }),
                  $('<span/>', { class: 'albumName', text: data.albumName }),
                ),
                $('<div/>', { class: 'header-add-song-icon' }).append(
                  $('<img/>', {
                    class: 'addSong',
                    id: data.trackID,
                    src:
                      'https://images.vexels.com/media/users/3/139162/isolated/preview/8b23fcb6b6c68d0f290b8dc5b5252214-cross-or-plus-icon-by-vexels.png',
                    alt: '',
                    width: 18,
                    height: 18,
                  }),
                ),
              ),
            ),
            $('<hr>'),
          );
        },
      });

      $.ajax({
        url: '/getLyrics',
        method:'POST',
        dataType: 'json',
        contentType: "application/json",
        data: JSON.stringify({ artist: data.artistName, song: data.songName }),

        success: function(response) {
          generateBlackout(response, data.artistName, data.songName)
          console.log(response.split(/\r\n|\r|\n/));
        }
      });
    });

    socket.on('pauseSong', function (data) {
      $.ajax({
        url: 'https://api.spotify.com/v1/me/player/pause',
        contentType: 'application/json',
        type: 'PUT',
        dataType: 'json',
        headers: {
          Authorization: 'Bearer ' + access_token,
        },
        data: JSON.stringify({ device_id: userdeviceID }),
        success: function (response) {},
      });
    });

    socket.on('resumeSong', function (data) {
      $.ajax({
        url: 'https://api.spotify.com/v1/me/player/play',
        contentType: 'application/json',
        type: 'PUT',
        dataType: 'json',
        headers: {
          Authorization: 'Bearer ' + access_token,
        },
        data: '',
        success: function (response) {},
      });
    });

    socket.on('showLyrics', function (data) {
      console.log(data);
      console.log("we're in");
    });

    function getUserDeviceInfo() {
      $.ajax({
        url: 'https://api.spotify.com/v1/me/player/devices',
        headers: {
          Authorization: 'Bearer ' + access_token,
        },
        json: true,
      }).done(function (response) {
        for (var i = 0; i < response.devices.length; i++) {
          if (response.devices[i]['is_active'] == true) {
            userdeviceID = response.devices[i]['id'];
          } else if (response.devices.length == 1) {
            userdeviceID = response.devices[i]['id'];
          } else if (response.devices[i]['type'] == 'Computer') {
            userdeviceID = response.devices[i]['id'];
          }
        }

        console.log('DeviceID ' + userdeviceID);
        console.log(response);
        var deviceArray = [];
        deviceArray[0] = userdeviceID;
        $.ajax({
          url: 'https://api.spotify.com/v1/me/player',
          headers: {
            Authorization: 'Bearer ' + access_token,
          },
          contentType: 'application/json',
          type: 'PUT',
          data: JSON.stringify({ device_ids: [userdeviceID] }),
        }).done(function (response) {
          console.log('Playback successfully transferred');
        });
      });
    }

    function generateBlackout(lyrics, artistName, songName)
    {
      let poem = lyrics;
      let poem_lines = poem.split(/\r\n|\r|\n/);
      poem_lines = poem_lines.filter(item => item);
      let poem_num_lines = poem_lines.length;
      let poem_text = [];

      for (var i = 0; i < poem_num_lines; i++) {
          // deconstruct string to array of words
          let words_in_line = poem_lines[i].split(" ");
          var num_words = words_in_line.length + 1;

          // get random # of words to hide
          var index_of_words_to_hide = getWhichWordstoBlackout(num_words);

          // add blackout to words
          for (var j = 0; j < index_of_words_to_hide.length; j++) {
            words_in_line[index_of_words_to_hide[j]] =
              '<span class="blackout">' +
              words_in_line[index_of_words_to_hide[j]] +
              "</span>";
          }


          poem_lines[i] = convertBackToString(words_in_line);
        }

        // format all poem text into string with line breaks
       for (var i = 0; i < poem_num_lines; i++) {
         poem_text += poem_lines[i] + "<br>";
       }

       window.setTimeout(function() {
          $("#title").html("<p>" + "Title: " + songName + "</p>");
          $("#author").html("<p>" + "Author: " + artistName + "</p>");
          $("#poem").html("<p>" + poem_text + "</p>");
        }, 300);

        return false;

    };

    function convertBackToString(array_of_words) {
      let poem_text = "";

      for (let i = 0; i < array_of_words.length - 1; i++) {
        poem_text += array_of_words[i];

        // if the current word and the next word start with span, it means the space in between
        // should be a span
        if (
          array_of_words[i].startsWith("<s") &&
          array_of_words[i + 1].startsWith("<s")
        ) {
          poem_text += '<span class="blackout"> </span>';
        } else {
          poem_text += " ";
        }
      }
      return poem_text;
    }

    function getWhichWordstoBlackout(num_words_in_sentence) {
      const MIN_PERECENT_OF_WORDS_TO_BLACKOUT = 0.8;

      // lets make sure its at least 80% of the sentence
      let number_of_words_to_hide = getRandomInt(
        Math.floor(num_words_in_sentence * MIN_PERECENT_OF_WORDS_TO_BLACKOUT),
        num_words_in_sentence
      );

      // loop through number of words to hide until you have enough
      let index_of_words_to_hide = [];

      for (
        let i = 0;
        index_of_words_to_hide.length < number_of_words_to_hide;
        i++
      ) {
        index_of_words_to_hide.push(getRandomInt(0, num_words_in_sentence));

        // set everytime to make sure numbers stay unique
        index_of_words_to_hide = [...new Set(index_of_words_to_hide)];
      }

      return index_of_words_to_hide;
    }

    function getRandomInt(min, max) {
    // lets make sure they're integers
    min = Math.ceil(min);
    max = Math.floor(max);

    return Math.floor(Math.random() * (max - min)) + min;
  }

  function getRandomLineNumber() {
    return getRandomInt(2, 10);
  }



    document.getElementById('channel1').addEventListener('click', function () {
      if ($(this).hasClass('paused')) {
        leaveChannel('channel2');
        joinChannel('channel1');
        $(this).toggleClass('paused');
        $('#channel1').attr('src', 'https://simpleicon.com/wp-content/uploads/pause.png');
        $('#channel2').attr('src', 'http://simpleicon.com/wp-content/uploads/play1-64x64.png');
        $('#channel2').addClass('paused');
      } else {
        leaveChannel('channel1');
        $(this).toggleClass('paused');
        $('#channel1').attr('src', 'http://simpleicon.com/wp-content/uploads/play1-64x64.png');
      }
    });

    document.getElementById('channel2').addEventListener('click', function () {
      if ($(this).hasClass('paused')) {
        leaveChannel('channel1');
        joinChannel('channel2');
        $(this).toggleClass('paused');
        $('#channel2').attr('src', 'https://simpleicon.com/wp-content/uploads/pause.png');
        $('#channel1').attr('src', 'http://simpleicon.com/wp-content/uploads/play1-64x64.png');
        $('#channel1').addClass('paused');
      } else {
        leaveChannel('channel2');
        $(this).toggleClass('paused');
        $('#channel2').attr('src', 'http://simpleicon.com/wp-content/uploads/play1-64x64.png');
      }
    });

    $(document).on('click', '.addSong', function () {
      var selectedSong;
      selectedSong = $(this).attr('id');

      $.ajax({
        url: 'https://api.spotify.com/v1/me/tracks',
        contentType: 'application/json',
        type: 'PUT',
        dataType: 'json',
        headers: {
          Authorization: 'Bearer ' + access_token,
        },
        data: JSON.stringify({ ids: [selectedSong] }),
        success: function (response) {},
      });

      $(this).attr(
        'src',
        'https://cdn1.iconfinder.com/data/icons/freeline/32/accept_check_ok_outline_tick_yes-20.png',
      );
    });

    $(document).ajaxError(function (event, jqxhr, settings, exception) {
      if (jqxhr.status == 401) {
        refreshToken();
      }
    });
  </script>
</html>
